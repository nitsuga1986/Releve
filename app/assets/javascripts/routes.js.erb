// ROUTING ================================================
angular.module("TurnosApp")
	.config(['$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {
		$routeProvider
		// Actividad 
		.when("/dashboard/actividad/index", { title: 'Listado de actividades',templateUrl: "<%= asset_path('actividad/index.html') %> ", controller: "ActividadIndexCtrl", activetab: 'actividad'})
		.when("/dashboard/actividad/new", { title: 'Nuevo actividad',templateUrl: "<%= asset_path('actividad/edit.html') %> ", controller: "ActividadEditCtrl", activetab: 'actividad'})
		.when("/dashboard/actividad/:id", { title: 'Detalles de la actividad',templateUrl: "<%= asset_path('actividad/show.html') %> ", controller: "ActividadShowCtrl", activetab: 'actividad'})
		.when("/dashboard/actividad/:id/edit", { title: 'Editar actividad',templateUrl: "<%= asset_path('actividad/edit.html') %> ", controller: "ActividadEditCtrl", activetab: 'actividad'})
		// Clases 
		.when("/dashboard/index", { title: 'Listado de clases',templateUrl: "<%= asset_path('clase/index.html') %> ", controller: "ClaseIndexCtrl", activetab: 'clase'})
		.when("/dashboard/new", { title: 'Nueva clase',templateUrl: "<%= asset_path('clase/edit.html') %> ", controller: "ClaseEditCtrl", activetab: 'clase'})
		.when("/dashboard/bulk", { title: 'Nuevas clases en masa',templateUrl: "<%= asset_path('clase/bulk.html') %> ", controller: "ClaseBulkCtrl", activetab: 'clase'})
		.when("/dashboard/join", { title: 'Inscripciones',templateUrl: "<%= asset_path('clase/join.html') %> ", controller: "ClaseJoinCtrl", activetab: 'clase'})
		.when("/dashboard/:id", { title: 'Detalles de la clase',templateUrl: "<%= asset_path('clase/show.html') %> ", controller: "ClaseShowCtrl", activetab: 'clase'})
		.when("/dashboard/:id/edit", { title: 'Editar clase',templateUrl: "<%= asset_path('clase/edit.html') %> ", controller: "ClaseEditCtrl", activetab: 'clase'})
		// Alumnos 
		.when("/alumno/index", { title: 'Listado de alumnos',templateUrl: "<%= asset_path('alumno/index.html') %> ", controller: "AlumnoIndexCtrl", activetab: 'alumno'})
		.when("/alumno/new", { title: 'Nuevo alumno',templateUrl: "<%= asset_path('alumno/edit.html') %> ", controller: "AlumnoEditCtrl", activetab: 'alumno'})
		.when("/alumno/:id", { title: 'Detalles de la alumno',templateUrl: "<%= asset_path('alumno/show.html') %> ", controller: "AlumnoShowCtrl", activetab: 'alumno'})
		.when("/alumno/:id/edit", { title: 'Editar alumno',templateUrl: "<%= asset_path('alumno/edit.html') %> ", controller: "AlumnoEditCtrl", activetab: 'alumno'})
		// Otros
		.otherwise({ redirectTo: "/" });
		// Fixes # in the routes. Not in IE...
		if(window.history && window.history.pushState){$locationProvider.html5Mode(true);}
}])
// AngularJS Interceptor
//The following AngularJS Interceptor can be used to globally handle any 401 error, and handle them by redirecting the user to the /login page.
.factory('authHttpResponseInterceptor',['$q','$location','$window',function($q,$location,$window){ 
    return {
        response: function(response){
            if (response.status === 401) {
                console.log("Response 401");
            }
            return response || $q.when(response);
        },
        responseError: function(rejection) {
            if (rejection.status === 401) {
                console.log("Response Error 401",rejection);
                $window.location.href = '/users/sign_in';
            }
            return $q.reject(rejection);
        }
    }
}])
.config(['$httpProvider',function($httpProvider) {
    //Http Intercpetor to check auth failures for xhr requests
    $httpProvider.interceptors.push('authHttpResponseInterceptor');
}]);	

angular.module("TurnosApp").run(['$location', '$rootScope', function($location, $rootScope) {
	$rootScope.$on('$routeChangeSuccess', function (event, current, previous) {
		$rootScope.title = " | "+current.$$route.title;
		$rootScope.activetab = current.$$route.activetab;
	});
}]);

angular.module("TurnosApp").config(['$httpProvider',function($httpProvider) {
	$httpProvider.defaults.headers.common['X-CSRF-Token'] = $('meta[name=csrf-token]').attr('content');
    $httpProvider.defaults.headers.common["X-Requested-With"] = 'XMLHttpRequest';
}]);
